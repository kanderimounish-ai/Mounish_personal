-- Create Database
CREATE DATABASE movie_store;

-- Create Table
CREATE TABLE student (
    student_id INT PRIMARY KEY,
    name VARCHAR(50),
    age INT
);

-- Insert Into Table
INSERT INTO student (student_id, name, age)
VALUES (1, 'John Doe', 22);

-- Select All
SELECT * FROM film;

-- Select Specific Columns
SELECT title, release_year FROM film;

-- Alter Table
ALTER TABLE student ADD email VARCHAR(100);
ALTER TABLE student MODIFY age SMALLINT;
ALTER TABLE student DROP COLUMN email;

-- Unique & Not Null
CREATE TABLE employee (
    id INT PRIMARY KEY,
    email VARCHAR(100) UNIQUE,
    name VARCHAR(50) NOT NULL
);

-- Primary Key
CREATE TABLE city (
    city_id INT PRIMARY KEY,
    city VARCHAR(50)
);

-- Foreign Key
ALTER TABLE customer
ADD FOREIGN KEY (store_id) REFERENCES store(store_id);

-- Check + Default
CREATE TABLE product (
    id INT PRIMARY KEY,
    price DECIMAL(5,2) CHECK (price > 0),
    status VARCHAR(10) DEFAULT 'ACTIVE'
);

-- Drop Table
DROP TABLE customer_backup;

-- Delete Rows
DELETE FROM customer WHERE customer_id = 3;

-- Truncate Table
TRUNCATE TABLE customer;

-- Count & Distinct Count
SELECT COUNT(*) FROM film;
SELECT COUNT(DISTINCT rating) FROM film;

-- Limit
SELECT * FROM film LIMIT 5;

-- WHERE Filter
SELECT * FROM customer WHERE first_name = 'JON';

-- ORDER BY Sorting
SELECT * FROM film ORDER BY rental_rate DESC;

-- AND / OR / NOT
SELECT * FROM film WHERE rating = 'PG' AND rental_rate > 2.99;
SELECT * FROM film WHERE rating = 'PG' OR rating = 'G';
SELECT * FROM film WHERE NOT (rating = 'R');

-- LIKE
SELECT * FROM customer WHERE first_name LIKE 'A%';

-- NULL Check
SELECT * FROM payment WHERE amount IS NULL;

-- BETWEEN
SELECT * FROM film WHERE rental_rate BETWEEN 2 AND 4;

-- GROUP BY + HAVING
SELECT rating, COUNT(*) AS film_count
FROM film
GROUP BY rating
HAVING COUNT(*) > 150;

-- Substring
SELECT SUBSTRING(title, 1, 5) FROM film;

-- Concat
SELECT CONCAT(first_name, ' ', last_name) FROM customer;

-- Length
SELECT LENGTH(title) FROM film;

-- Locate
SELECT LOCATE('A', title) FROM film;

-- Substring Index
SELECT SUBSTRING_INDEX(title, ' ', 1) FROM film;

-- Math Functions
SELECT CEIL(rental_rate), FLOOR(rental_rate) FROM film;

-- Date Difference
SELECT DATEDIFF(return_date, rental_date) FROM rental;

-- Cast
SELECT CAST(rental_rate AS CHAR) FROM film;

-- INNER JOIN
SELECT f.title, c.name
FROM film f
INNER JOIN film_category fc ON f.film_id = fc.film_id
INNER JOIN category c ON fc.category_id = c.category_id;

-- LEFT JOIN
SELECT f.title, i.inventory_id
FROM film f
LEFT JOIN inventory i ON f.film_id = i.film_id;

-- RIGHT JOIN
SELECT f.title, i.inventory_id
FROM film f
RIGHT JOIN inventory i ON f.film_id = i.film_id;

-- FULL OUTER JOIN (Simulated)
SELECT * FROM A
LEFT JOIN B ON A.id = B.id
UNION
SELECT * FROM A
RIGHT JOIN B ON A.id = B.id;

-- CROSS JOIN
SELECT a.first_name, f.title
FROM actor a
CROSS JOIN film f;

-- SELF JOIN
SELECT f1.title, f2.title
FROM film f1
JOIN film f2 ON f1.length = f2.length;

-- DISTINCT with JOIN
SELECT DISTINCT c.name
FROM category c
JOIN film_category fc ON c.category_id = fc.category_id;

1. CTE â€” Common Table Expressions

-- Simple CTE
WITH top_rated AS (
    SELECT film_id, title, rating
    FROM film
    WHERE rating = 'PG'
)
SELECT * FROM top_rated;

-- CTE with Aggregation
WITH rental_count AS (
    SELECT film_id, COUNT(*) AS total_rentals
    FROM rental
    JOIN inventory USING (inventory_id)
    GROUP BY film_id
)
SELECT *
FROM rental_count
WHERE total_rentals > 50
ORDER BY total_rentals DESC;

-- Multiple CTEs
WITH active_customers AS (
    SELECT customer_id, first_name, last_name
    FROM customer
    WHERE active = 1
),
payments AS (
    SELECT customer_id, SUM(amount) AS total_paid
    FROM payment
    GROUP BY customer_id
)
SELECT a.*, p.total_paid
FROM active_customers a
JOIN payments p USING (customer_id)
ORDER BY p.total_paid DESC;


2. Temporary Tables

-- Create Temporary Table
CREATE TEMPORARY TABLE temp_top_customers AS
SELECT customer_id, SUM(amount) AS total_payment
FROM payment
GROUP BY customer_id
ORDER BY total_payment DESC
LIMIT 10;

-- Query Temporary Table
SELECT *
FROM temp_top_customers;

-- Insert into Temporary Table
INSERT INTO temp_top_customers
SELECT customer_id, SUM(amount)
FROM payment
GROUP BY customer_id
LIMIT 5;

-- Drop Temporary Table (optional)
DROP TEMPORARY TABLE temp_top_customers;


3. Views

-- Create View
CREATE VIEW active_customer_view AS
SELECT customer_id, first_name, last_name, email
FROM customer
WHERE active = 1;

-- Query View
SELECT *
FROM active_customer_view
ORDER BY last_name;

-- Update Through a View (if allowed)
UPDATE active_customer_view
SET email = 'newemail@example.com'
WHERE customer_id = 5;

-- Drop View
DROP VIEW active_customer_view;

-- View with Aggregation
CREATE VIEW customer_payment_summary AS
SELECT 
    c.customer_id,
    CONCAT(c.first_name, ' ', c.last_name) AS fullname,
    SUM(p.amount) AS total_paid
FROM customer c
JOIN payment p USING (customer_id)
GROUP BY c.customer_id;

SELECT * FROM customer_payment_summary
ORDER BY total_paid DESC;

-- Complex View with JOINs
CREATE VIEW film_category_view AS
SELECT 
    f.film_id,
    f.title,
    c.name AS category
FROM film f
JOIN film_category fc ON f.film_id = fc.film_id
JOIN category c ON fc.category_id = c.category_id;

SELECT * FROM film_category_view LIMIT 20;

